<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Web Scraping</title>

<script src="7-web-scraping_files/header-attrs-2.23/header-attrs.js"></script>
<script src="7-web-scraping_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="7-web-scraping_files/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="7-web-scraping_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="7-web-scraping_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="7-web-scraping_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="7-web-scraping_files/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="7-web-scraping_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="7-web-scraping_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="7-web-scraping_files/navigation-1.1/tabsets.js"></script>
<link href="7-web-scraping_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="7-web-scraping_files/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="custom.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">



<h1 class="title toc-ignore">Web Scraping</h1>
<h3 class="subtitle">Collecting Data from the Web using R</h3>

</div>


<hr />
<p>After talking quite a bit about web data in the last session, today‚Äôs
session is dedicated to data collection - from the web!</p>
<p>What we will cover:</p>
<ul>
<li>scraping static webpages</li>
<li>scraping multiple static webpages</li>
<li>API calls</li>
<li>building up and maintaining you own original sets of web-based
data</li>
</ul>
<p>What we will not cover (today):</p>
<ul>
<li>scraping dynamic webpages</li>
</ul>
<div id="why-webscrape-with-r" class="section level1">
<h1>Why webscrape with R? üåè</h1>
<p>Webscraping broadly includes a) getting (unstructured) data from the
web and b) bringing it into shape (e.g.¬†cleaning it, getting it into
tabular format).</p>
<p>Why webscrape? While some influential people consider ‚ÄúData
Scientist‚Äù üë©‚Äçüíª to be the <a
href="https://hbr.org/2012/10/data-scientist-the-sexiest-job-of-the-21st-century">sexiest
job</a> of the 21st century (congratulations!), one of the sexiest just
emerging academic disciplines is (in my influential view) -
Computational Social Science (CSS). Why is that so?</p>
<ul>
<li>data abundance online</li>
<li>social interaction online</li>
<li>services track social behavior</li>
</ul>
<p>BUT online data are usually meant for display, not a (clean)
download!</p>
<p>But getting access to online data would also be incredibly
interesting when you think of very pragmatic things like financial
resources, time resources, reproducibility and updateability‚Ä¶</p>
<p>Luckily, with <code>R</code> we can automate the whole pipeline of
downloading, parsing and post-processing to make our projects easily
reproducible.</p>
<p>In general, remember, the basic <strong>workflow for scraping static
webpages</strong> is the following.</p>
<p><img src="pics/workflow.png" width="90%" style="display: block; margin: auto;" /></p>
</div>
<div id="scraping-static-sites-with-rvest" class="section level1">
<h1>Scraping static sites with <code>rvest</code> üöú</h1>
<p>Who doesn‚Äôt love Wikipedia? Let‚Äôs use this as our first, straight
forward test case.</p>
<p><strong>Step 1.</strong> Load the packages <code>rvest</code> and
<code>stringr</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(here)</span></code></pre></div>
<p><strong>Step 2.</strong> Parse the page source.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>parsed_url <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">&quot;https://en.wikipedia.org/wiki/Cologne&quot;</span>)</span></code></pre></div>
<p><strong>Step 3.</strong> Extract information.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>parsed_url <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">html_element</span>(<span class="at">xpath =</span> <span class="st">&#39;//p[(((count(preceding-sibling::*) + 1) = 172) and parent::*)]&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="fu">html_text</span>()</span></code></pre></div>
<pre><code>## [1] &quot;The Cologne carnival is one of the largest street festivals in Europe. In Cologne, the carnival season officially starts on 11 November at 11 minutes past 11¬†a.m. with the proclamation of the new Carnival Season, and continues until Ash Wednesday. However, the so-called \&quot;Tolle Tage\&quot; (crazy days) do not start until Weiberfastnacht (Women&#39;s Carnival) or, in dialect, Wieverfastelovend, the Thursday before Ash Wednesday, which is the beginning of the street carnival. Z√ºlpicher Strasse and its surroundings, Neumarkt square, Heumarkt and all bars and pubs in the city are crowded with people in costumes dancing and drinking in the streets. Hundreds of thousands of visitors flock to Cologne during this time. Generally, around a million people celebrate in the streets on the Thursday before Ash Wednesday.[67]&quot;</code></pre>
<p>There are two options:</p>
<p><strong>Option 1.</strong> On your page of interest, go to a table
that you‚Äôd like to scrape. Our favorite bowser for webscraping is Google
Chrome but others work as well. On Chrome, you go in View &gt; Developer
&gt; inspect elements. If you hover over the html code on the right, you
should see boxes of different colors framing different elements of the
page. Once the part of the page you would like to scrape is selected,
right click on the html code and Copy &gt; Copy Xpath. That‚Äôs it.</p>
<p><img src="pics/inspect.png" width="90%" style="display: block; margin: auto;" /></p>
<p><strong>Option 2.</strong> Something we did not show you, but that
you might look at in your own time is the Chrome Extension
<code>SelectorGadget</code>. You download the <a
href="https://chrome.google.com/webstore/detail/selectorgadget/mhjhnkcfbdhnjickkkdbjoemdmbfginb?hl=de">Chrome
Extension</a> <code>SelectorGadget</code> and activate it while browsing
the page you‚Äôd like to scrape from. You will see a selection box moving
with your cursor. You select an element by clickin on it. It turns green
- and so does all other content that would be selected with the current
XPath.</p>
<p><img src="pics/selector.png" width="90%" style="display: block; margin: auto;" /></p>
<p>You can now de-select everything that is irrelevant to you by
clicking it again (it then turns red). Final step, then just click the
XPath button at the bottom of the browser window. Make sure to use
single quotation marks with this XPath!</p>
<p><img src="pics/selector2.png" width="90%" style="display: block; margin: auto;" /></p>
<p>Let‚Äôs repeat step 2 and 3 with a more data-sciency example. üéì</p>
<p><strong>Step 2.</strong> Parse the page source.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>nypl_url <span class="ot">&lt;-</span> <span class="st">&quot;https://www.nypl.org/books-more/recommendations/best-books/adults?year=2021&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>nypl100 <span class="ot">&lt;-</span> <span class="fu">read_html</span>(nypl_url)</span></code></pre></div>
<p><strong>Step 3.</strong> Extract information. When going through
different levels of html, you can also use tidyverse logic.</p>
<pre><code>body_nodes &lt;- nypl100 |&gt; 
 html_elements(&quot;body&quot;) |&gt; 
 html_children()

body_nodes |&gt; 
 html_children()</code></pre>
<p>play with that yourself if you like‚Ä¶</p>
<p>Now let‚Äôs have a look at the different ways to extract
information:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>title <span class="ot">&lt;-</span> nypl100 <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&#39;//ul/li/div/div/h4&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">html_text2</span>()</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>author <span class="ot">&lt;-</span> nypl100 <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="at">css =</span> <span class="st">&#39;.spbb-card__byline--grid&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">html_text2</span>()</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>summary <span class="ot">&lt;-</span> nypl100 <span class="sc">|&gt;</span> </span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&#39;//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;spbb-card__description--grid&quot;, &quot; &quot; ))]&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="fu">html_text2</span>()</span></code></pre></div>
<p><strong>Step 4.</strong> Usually step 4 involves cleaning extracted
data. In this case, it actually is pretty clean already, thanks to
<code>html_text2()</code>. However, in many cases, we need to clean the
data we scraped with regular expressions.</p>
<p><strong>Step 5.</strong> Put everything into a data frame. üìñ</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">data.frame</span>(title, author, summary) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>))</span></code></pre></div>
<table>
<colgroup>
<col width="9%" />
<col width="6%" />
<col width="83%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">title</th>
<th align="left">author</th>
<th align="left">summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Act Your Age, Eve Brown: A Novel</td>
<td align="left">By Talia Hibbert</td>
<td align="left">Jacob likes things in life to be neat and orderly. But
everything is turned upside down when Eve Brown blows into his life like
a sparkly tornado. This steamy opposites-attract romance will have you
laughing out loud and begging for more. Third in a series but it stands
alone.</td>
</tr>
<tr class="even">
<td align="left">Afterparties: Stories</td>
<td align="left">By Anthony Veasna So</td>
<td align="left">Seamlessly transitioning between the absurd and the
tenderhearted, this book offers a portrait of Cambodian-American lives.
Children of refugees shoulder the inherited weight of the Khmer Rouge
genocide and grapple with the complexities of race, sexuality,
friendship, and family.</td>
</tr>
<tr class="odd">
<td align="left">All Her Little Secrets: A Novel</td>
<td align="left">By Wanda M. Morris</td>
<td align="left">Ellice has safely guarded her secrets for years, but
when she discovers her boss dead in his office, all of them begin to
unravel.</td>
</tr>
</tbody>
</table>
<div id="scraping-html-tables" class="section level2">
<h2>Scraping HTML tables üöÄ</h2>
<p>Oftentimes, we would like to scrape tabular data from the web. This
is even easier in <code>rvest</code>!</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>url_p <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">&quot;https://en.wikipedia.org/wiki/Germany&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>deu_table <span class="ot">&lt;-</span> <span class="fu">html_table</span>(url_p, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">4</span>)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>deu_table <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="fu">select</span>(State, Capital) <span class="sc">|&gt;</span> </span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["State"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Capital"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Baden-W√ºrttemberg","2":"Stuttgart"},{"1":"Bavaria","2":"Munich"},{"1":"Berlin","2":"Berlin"},{"1":"Brandenburg","2":"Potsdam"},{"1":"Bremen","2":"Bremen"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div id="scraping-multiple-pages" class="section level1">
<h1>Scraping multiple pages ü§ñ</h1>
<p>Whenever you want to really understand what‚Äôs going on within the
functions of a new R package, it is very likely that there is a relevant
article published in the <a
href="https://www.jstatsoft.org/index">Journal of Statistical
Software</a>. Let‚Äôs say you are interested in how the journal was doing
over the past years.</p>
<p><strong>Step 1.</strong> Inspect the source. Basically, follow steps
to extract the Xpath information.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">browseURL</span>(<span class="st">&quot;http://www.jstatsoft.org/issue/archive&quot;</span>)</span></code></pre></div>
<p><strong>Step 2</strong> Develop a scraping strategy. We need a set of
URLs leading to all sources. Inspect the URLs of different sources and
find the pattern. Then, construct the list of URLs from scratch.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>baseurl <span class="ot">&lt;-</span> <span class="st">&quot;http://www.jstatsoft.org/article/view/v&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>volurl <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;0&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">99</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>volurl[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;00&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>brurl <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;0&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>urls_list <span class="ot">&lt;-</span> <span class="fu">cross2</span>(volurl, brurl) <span class="sc">|&gt;</span> <span class="fu">map_chr</span>(<span class="sc">~</span><span class="fu">paste0</span>(baseurl, .[[<span class="dv">1</span>]], <span class="st">&#39;i&#39;</span>, .[[<span class="dv">2</span>]]))</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">cross2</span>(volurl, brurl) <span class="sc">|&gt;</span> <span class="fu">map_chr</span>(<span class="sc">~</span><span class="fu">paste0</span>(.[[<span class="dv">1</span>]], <span class="st">&#39;_&#39;</span>, .[[<span class="dv">2</span>]], <span class="st">&#39;.html&#39;</span>))</span></code></pre></div>
<p><strong>Step 3</strong> Think about where you want your scraped
material to be stored and create a directory.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>tempwd <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;session-07-web-scraping/data/jstatsoftStats&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="fu">dir.create</span>(tempwd, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">setwd</span>(tempwd)</span></code></pre></div>
<p><strong>Step 4</strong> Download the pages. Note that we did not do
this step last time, when we were only scraping one page.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>folder <span class="ot">&lt;-</span> <span class="fu">paste0</span>(tempwd, <span class="st">&quot;/html_articles/&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">dir.create</span>(folder, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(urls_list)) {</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="co"># only update, don&#39;t replace</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">paste0</span>(folder, names[i]))) {</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="co"># skip article when we run into an error</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>      <span class="fu">download.file</span>(urls_list[i], <span class="at">destfile =</span> <span class="fu">paste0</span>(folder, names[i])),</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>        e</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>    )</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="co"># don&#39;t kill their server --&gt; be polite!</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>  } </span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>}</span></code></pre></div>
<p>While R is downloading the pages for you, you can watch it directly
in the directory you defined‚Ä¶</p>
<p><img src="pics/html_files.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Check whether it worked.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>list_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(folder, <span class="at">pattern =</span> <span class="st">&quot;0.*&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>list_files_path <span class="ot">&lt;-</span> <span class="fu">list.files</span>(folder, <span class="at">pattern =</span> <span class="st">&quot;0.*&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="fu">length</span>(list_files)</span></code></pre></div>
<p>Yay! Apparently, we scraped the html pages of 855 articles.</p>
<div id="gitignoring-files" class="section level2">
<h2>(Git)ignoring files üôÖ</h2>
<p>In case you scraping project is linked to GitHub (as it will be in
your assignment!), it can be useful to <strong>.gitignore</strong> the
folder of downloaded files. This means that the folder can be stored in
your local directory of the project but will not be synced with the
remote (main) repository. Here is information on how to do this using <a
href="https://carpentries-incubator.github.io/git-Rstudio-course/02-ignore/index.html">RStudio</a>.</p>
<p>In Github Desktop it is very simple, you do your scraping work, the
folder is created in your local repository and before your commit and
push these changes, you go on <code>Repository</code> &gt;
<code>Repository Settings</code> &gt; <code>Ignored Files</code> and
edit the .gitignore file (add the name of the new folder / files you
don‚Äôt want to sync). More generally, it makes sense to exclude .Rproj
files, .RData files (and other binary or large data files), draft
folders and sensitive information from version control. Remember, git is
built to track changes in code, not in large data files.</p>
<p><strong>Step 5</strong> Import files and parse out information. A
loop is helpful here!</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># define output first</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>authors <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>datePublish <span class="ot">&lt;-</span> <span class="fu">character</span>()</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co"># then run the loop</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(list_files_path)) {</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  </span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  html_out <span class="ot">&lt;-</span> <span class="fu">read_html</span>(list_files_path[i])</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    </span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  authors[i] <span class="ot">&lt;-</span> html_out <span class="sc">|&gt;</span> </span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&#39;//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;authors_long&quot;, &quot; &quot; ))]//strong&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="fu">html_text2</span>()</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    </span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  title[i] <span class="ot">&lt;-</span> html_out <span class="sc">|&gt;</span> </span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>    <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&#39;//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;page-header&quot;, &quot; &quot; ))]&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    <span class="fu">html_text2</span>()</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  datePublish[i] <span class="ot">&lt;-</span> html_out <span class="sc">|&gt;</span> </span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>    <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&#39;//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;article-meta&quot;, &quot; &quot; ))]//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;row&quot;, &quot; &quot; )) and (((count(preceding-sibling::*) + 1) = 2) and parent::*)]//*[contains(concat( &quot; &quot;, @class, &quot; &quot; ), concat( &quot; &quot;, &quot;col-sm-8&quot;, &quot; &quot; ))]&#39;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>    <span class="fu">html_text2</span>()</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  </span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>}</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co"># inspect data</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>authors[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>title[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>datePublish[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co"># create a data frame</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">authors =</span> authors, <span class="at">title =</span> title, <span class="at">datePublish =</span> datePublish)</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="fu">dim</span>(dat)</span></code></pre></div>
<p><strong>Step 6</strong> Clean data‚Ä¶</p>
<p>You see, scraping data from multiple pages is no problem in R. Most
of the brain work often goes into developing a scraping strategy and
tidying the data, not into the actual downloading/scraping part.</p>
<p>Scraping is also possible in much more complex scenarios! Watch out
for workshop presentations on</p>
<ul>
<li>Text analytics with <code>quanteda</code></li>
<li>Regular expressions with <code>stringr</code></li>
<li>Data cleaning with <code>janitor</code></li>
</ul>
<p>and many more ü§©</p>
</div>
</div>
<div id="good-scraping-practice" class="section level1">
<h1>Good scraping practice</h1>
<p>There is a set of general rules to the game:</p>
<ol style="list-style-type: decimal">
<li>You take all the <strong>responsibility</strong> for your web
scraping work.</li>
<li>Think about the nature of the data. Does it entail <strong>sensitive
information</strong>? Do not collect personal data without explicit
permission.</li>
<li>Take all <strong>copyrights</strong> of a country‚Äôs jurisdiction
into account. If you publish data, do not commit copyright fraud.</li>
<li>If possible, <strong>stay identifiable</strong>. Stay polite. Stay
friendly. Obey the scraping etiquette.</li>
<li>If in doubt, <strong>ask the author/creator/provider</strong> of
data for permission‚Äîif your interest is entirely scientific, chances
aren‚Äôt bad that you get data.</li>
</ol>
<div id="how-do-i-know-the-scraping-etiquette-of-a-site"
class="section level2">
<h2>How do I know the scraping etiquette of a site? ü§ù</h2>
<p>Robot exclusion standards (<code>robot.txt</code>) are informal
protocols to prohibit web robots from crawling content. They list
documents that are allowed to crawl and which not. It is not a technical
barrier but an ask for compliance. They are located in the root
directory of a website (e.g
<code>https://de.wikipedia.org/robots.txt</code>).</p>
<p>For example, let‚Äôs have a look at wikipedia‚Äôs <a
href="https://de.wikipedia.org/robots.txt">robot.txt</a> file, which is
very human readable.</p>
<p>General rules are listed under <code>User-agent: *</code> which is
most interesting for R-based crawlers. A universal ban for a directory
looks like this <code>Disallows: /</code>, sometimes Crawl-delays are
suggested (in seconds) <code>Crawl-delay: 2</code>.</p>
</div>
<div id="what-is-polite-scraping" class="section level2">
<h2>What is ‚Äúpolite‚Äù scraping? üêå</h2>
<p>First thing would be not to scrape at a speed that causes trouble for
their server. Therefore, whenever you loop over a list of URLs, add a
<code>Sys.sleep(runif(1, 1, 2))</code> at the end of the loop.</p>
<p>And generally, it is better practice to store data on your local
drive first (<code>download.file()</code>), then parse
(<code>read_html()</code>).</p>
<p><strong>A footnote on sustainability.</strong> In the digital
context, we often forget that or actions do have physical consequences.
For example, training AI, using blockchain, and streaming videos all
create considerable amounts of <span class="math inline">\(CO^2\)</span>
emissions. So does bombarding a server with requests - certainly to a
much lesser extent than the previous examples - but please consider
whether you have to re-run a large scraping project 100 times in order
to debug things.</p>
<p>Furthermore, downloading massive amounts of data may arouse attention
from server administrators. Assuming that you‚Äôve got nothing to hide,
you should stay identifiable beyond your IP address.</p>
</div>
<div id="how-can-i-stay-identifiable" class="section level2">
<h2>How can I stay identifiable? üë§</h2>
<p><strong>Option 1</strong>: Get in touch with website administrators /
data owners.</p>
<p><strong>Option 2</strong>: Use HTTP header fields <code>From</code>
and <code>User-Agent</code> to provide information about yourself.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">&quot;http://a-totally-random-website.com&quot;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>rvest_session <span class="ot">&lt;-</span> rvest<span class="sc">::</span><span class="fu">session</span>(url, </span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>                                httr<span class="sc">::</span><span class="fu">add_headers</span>(</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">From</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;my@email.com&quot;</span>, </span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>                                  <span class="st">`</span><span class="at">UserAgent</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">R.Version</span>()<span class="sc">$</span>version.string</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>                                  )</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>                                )</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>                </span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>scraped_text <span class="ot">&lt;-</span> rvest_session <span class="sc">|&gt;</span> </span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>            <span class="fu">html_elements</span>(<span class="at">xpath =</span> <span class="st">&quot;p//a&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>            <span class="fu">html_text</span>()</span></code></pre></div>
<p>rvest‚Äôs <code>session()</code> creates a session object that responds
to HTTP and HTML methods. Here, we provide our email address and the
current R version as User-Agent information. This will pop up in the
server logs: The webpage administrator has the chance to easily get in
touch with you.</p>
</div>
</div>
<div id="on-an-api-far-far-away" class="section level1">
<h1>On an API far, far away‚Ä¶ ‚≠ê</h1>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="fu">library</span>(glue)</span></code></pre></div>
<p>To get data from an API, we suggest to follow a workflow like
this:</p>
<ol style="list-style-type: decimal">
<li>Read the APIs documentation!</li>
<li>Get the baseurl</li>
<li>Find out the parameters referring to the resources of interest to
you</li>
<li>Create a query url from the base url and the query parameters</li>
<li>Run the <code>GET</code> function on the query url</li>
<li>Depending on the encoding (usually, it‚Äôs json), you will need
to:</li>
</ol>
<ul>
<li>Parse the result with the <code>content</code> function</li>
<li>Either use <code>jsonlite</code> or <code>xml2</code> to parse the
json or xml files</li>
</ul>
<p>Let‚Äôs have a look at an example, the <a
href="https://swapi.dev/">Star Wars API</a>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>baseurl <span class="ot">&lt;-</span> <span class="st">&quot;https://swapi.dev/api/&quot;</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&#39;films&#39;</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="fu">GET</span>(<span class="fu">paste0</span>(baseurl, query)) <span class="sc">|&gt;</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&#39;text&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>  <span class="fu">fromJSON</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["title"],"name":[1],"type":["chr"],"align":["left"]},{"label":["episode_id"],"name":[2],"type":["int"],"align":["right"]},{"label":["opening_crawl"],"name":[3],"type":["chr"],"align":["left"]},{"label":["director"],"name":[4],"type":["chr"],"align":["left"]},{"label":["producer"],"name":[5],"type":["chr"],"align":["left"]},{"label":["release_date"],"name":[6],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[7],"type":["list"],"align":["right"]},{"label":["planets"],"name":[8],"type":["list"],"align":["right"]},{"label":["starships"],"name":[9],"type":["list"],"align":["right"]},{"label":["vehicles"],"name":[10],"type":["list"],"align":["right"]},{"label":["species"],"name":[11],"type":["list"],"align":["right"]},{"label":["created"],"name":[12],"type":["chr"],"align":["left"]},{"label":["edited"],"name":[13],"type":["chr"],"align":["left"]},{"label":["url"],"name":[14],"type":["chr"],"align":["left"]}],"data":[{"1":"A New Hope","2":"4","3":"It is a period of civil war.\\r\\nRebel spaceships, striking\\r\\nfrom a hidden base, have won\\r\\ntheir first victory against\\r\\nthe evil Galactic Empire.\\r\\n\\r\\nDuring the battle, Rebel\\r\\nspies managed to steal secret\\r\\nplans to the Empire's\\r\\nultimate weapon, the DEATH\\r\\nSTAR, an armored space\\r\\nstation with enough power\\r\\nto destroy an entire planet.\\r\\n\\r\\nPursued by the Empire's\\r\\nsinister agents, Princess\\r\\nLeia races home aboard her\\r\\nstarship, custodian of the\\r\\nstolen plans that can save her\\r\\npeople and restore\\r\\nfreedom to the galaxy....","4":"George Lucas","5":"Gary Kurtz, Rick McCallum","6":"1977-05-25","7":"<chr [18]>","8":"<chr [3]>","9":"<chr [8]>","10":"<chr [4]>","11":"<chr [5]>","12":"2014-12-10T14:23:31.880000Z","13":"2014-12-20T19:49:45.256000Z","14":"https://swapi.dev/api/films/1/","_rn_":"1"},{"1":"The Empire Strikes Back","2":"5","3":"It is a dark time for the\\r\\nRebellion. Although the Death\\r\\nStar has been destroyed,\\r\\nImperial troops have driven the\\r\\nRebel forces from their hidden\\r\\nbase and pursued them across\\r\\nthe galaxy.\\r\\n\\r\\nEvading the dreaded Imperial\\r\\nStarfleet, a group of freedom\\r\\nfighters led by Luke Skywalker\\r\\nhas established a new secret\\r\\nbase on the remote ice world\\r\\nof Hoth.\\r\\n\\r\\nThe evil lord Darth Vader,\\r\\nobsessed with finding young\\r\\nSkywalker, has dispatched\\r\\nthousands of remote probes into\\r\\nthe far reaches of space....","4":"Irvin Kershner","5":"Gary Kurtz, Rick McCallum","6":"1980-05-17","7":"<chr [16]>","8":"<chr [4]>","9":"<chr [9]>","10":"<chr [6]>","11":"<chr [5]>","12":"2014-12-12T11:26:24.656000Z","13":"2014-12-15T13:07:53.386000Z","14":"https://swapi.dev/api/films/2/","_rn_":"2"},{"1":"Return of the Jedi","2":"6","3":"Luke Skywalker has returned to\\r\\nhis home planet of Tatooine in\\r\\nan attempt to rescue his\\r\\nfriend Han Solo from the\\r\\nclutches of the vile gangster\\r\\nJabba the Hutt.\\r\\n\\r\\nLittle does Luke know that the\\r\\nGALACTIC EMPIRE has secretly\\r\\nbegun construction on a new\\r\\narmored space station even\\r\\nmore powerful than the first\\r\\ndreaded Death Star.\\r\\n\\r\\nWhen completed, this ultimate\\r\\nweapon will spell certain doom\\r\\nfor the small band of rebels\\r\\nstruggling to restore freedom\\r\\nto the galaxy...","4":"Richard Marquand","5":"Howard G. Kazanjian, George Lucas, Rick McCallum","6":"1983-05-25","7":"<chr [20]>","8":"<chr [5]>","9":"<chr [12]>","10":"<chr [8]>","11":"<chr [9]>","12":"2014-12-18T10:39:33.255000Z","13":"2014-12-20T09:48:37.462000Z","14":"https://swapi.dev/api/films/3/","_rn_":"3"},{"1":"The Phantom Menace","2":"1","3":"Turmoil has engulfed the\\r\\nGalactic Republic. The taxation\\r\\nof trade routes to outlying star\\r\\nsystems is in dispute.\\r\\n\\r\\nHoping to resolve the matter\\r\\nwith a blockade of deadly\\r\\nbattleships, the greedy Trade\\r\\nFederation has stopped all\\r\\nshipping to the small planet\\r\\nof Naboo.\\r\\n\\r\\nWhile the Congress of the\\r\\nRepublic endlessly debates\\r\\nthis alarming chain of events,\\r\\nthe Supreme Chancellor has\\r\\nsecretly dispatched two Jedi\\r\\nKnights, the guardians of\\r\\npeace and justice in the\\r\\ngalaxy, to settle the conflict....","4":"George Lucas","5":"Rick McCallum","6":"1999-05-19","7":"<chr [34]>","8":"<chr [3]>","9":"<chr [5]>","10":"<chr [7]>","11":"<chr [20]>","12":"2014-12-19T16:52:55.740000Z","13":"2014-12-20T10:54:07.216000Z","14":"https://swapi.dev/api/films/4/","_rn_":"4"},{"1":"Attack of the Clones","2":"2","3":"There is unrest in the Galactic\\r\\nSenate. Several thousand solar\\r\\nsystems have declared their\\r\\nintentions to leave the Republic.\\r\\n\\r\\nThis separatist movement,\\r\\nunder the leadership of the\\r\\nmysterious Count Dooku, has\\r\\nmade it difficult for the limited\\r\\nnumber of Jedi Knights to maintain \\r\\npeace and order in the galaxy.\\r\\n\\r\\nSenator Amidala, the former\\r\\nQueen of Naboo, is returning\\r\\nto the Galactic Senate to vote\\r\\non the critical issue of creating\\r\\nan ARMY OF THE REPUBLIC\\r\\nto assist the overwhelmed\\r\\nJedi....","4":"George Lucas","5":"Rick McCallum","6":"2002-05-16","7":"<chr [40]>","8":"<chr [5]>","9":"<chr [9]>","10":"<chr [11]>","11":"<chr [14]>","12":"2014-12-20T10:57:57.886000Z","13":"2014-12-20T20:18:48.516000Z","14":"https://swapi.dev/api/films/5/","_rn_":"5"},{"1":"Revenge of the Sith","2":"3","3":"War! The Republic is crumbling\\r\\nunder attacks by the ruthless\\r\\nSith Lord, Count Dooku.\\r\\nThere are heroes on both sides.\\r\\nEvil is everywhere.\\r\\n\\r\\nIn a stunning move, the\\r\\nfiendish droid leader, General\\r\\nGrievous, has swept into the\\r\\nRepublic capital and kidnapped\\r\\nChancellor Palpatine, leader of\\r\\nthe Galactic Senate.\\r\\n\\r\\nAs the Separatist Droid Army\\r\\nattempts to flee the besieged\\r\\ncapital with their valuable\\r\\nhostage, two Jedi Knights lead a\\r\\ndesperate mission to rescue the\\r\\ncaptive Chancellor....","4":"George Lucas","5":"Rick McCallum","6":"2005-05-19","7":"<chr [34]>","8":"<chr [13]>","9":"<chr [12]>","10":"<chr [13]>","11":"<chr [20]>","12":"2014-12-20T18:49:38.403000Z","13":"2014-12-20T20:47:52.073000Z","14":"https://swapi.dev/api/films/6/","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&#39;people/?search=skywalker&#39;</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="fu">GET</span>(<span class="fu">paste0</span>(baseurl, query)) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&#39;text&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="fu">fromJSON</span>() <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">4</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["name"],"name":[1],"type":["chr"],"align":["left"]},{"label":["height"],"name":[2],"type":["chr"],"align":["left"]},{"label":["mass"],"name":[3],"type":["chr"],"align":["left"]},{"label":["hair_color"],"name":[4],"type":["chr"],"align":["left"]},{"label":["skin_color"],"name":[5],"type":["chr"],"align":["left"]},{"label":["eye_color"],"name":[6],"type":["chr"],"align":["left"]},{"label":["birth_year"],"name":[7],"type":["chr"],"align":["left"]},{"label":["gender"],"name":[8],"type":["chr"],"align":["left"]},{"label":["homeworld"],"name":[9],"type":["chr"],"align":["left"]},{"label":["films"],"name":[10],"type":["list"],"align":["right"]},{"label":["species"],"name":[11],"type":["list"],"align":["right"]},{"label":["vehicles"],"name":[12],"type":["list"],"align":["right"]},{"label":["starships"],"name":[13],"type":["list"],"align":["right"]},{"label":["created"],"name":[14],"type":["chr"],"align":["left"]},{"label":["edited"],"name":[15],"type":["chr"],"align":["left"]},{"label":["url"],"name":[16],"type":["chr"],"align":["left"]}],"data":[{"1":"Luke Skywalker","2":"172","3":"77","4":"blond","5":"fair","6":"blue","7":"19BBY","8":"male","9":"https://swapi.dev/api/planets/1/","10":"<chr [4]>","11":"<list [0]>","12":"<chr [2]>","13":"<chr [2]>","14":"2014-12-09T13:50:51.644000Z","15":"2014-12-20T21:17:56.891000Z","16":"https://swapi.dev/api/people/1/","_rn_":"1"},{"1":"Anakin Skywalker","2":"188","3":"84","4":"blond","5":"fair","6":"blue","7":"41.9BBY","8":"male","9":"https://swapi.dev/api/planets/1/","10":"<chr [3]>","11":"<list [0]>","12":"<chr [2]>","13":"<chr [3]>","14":"2014-12-10T16:20:44.310000Z","15":"2014-12-20T21:17:50.327000Z","16":"https://swapi.dev/api/people/11/","_rn_":"2"},{"1":"Shmi Skywalker","2":"163","3":"unknown","4":"black","5":"fair","6":"brown","7":"72BBY","8":"female","9":"https://swapi.dev/api/planets/1/","10":"<chr [2]>","11":"<list [0]>","12":"<chr [0]>","13":"<chr [0]>","14":"2014-12-19T17:57:41.191000Z","15":"2014-12-20T21:17:50.401000Z","16":"https://swapi.dev/api/people/43/","_rn_":"3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>If you do not know the source format, the <code>http_type</code>
function will help you out!</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&#39;starships/?search=death/?format=wookiee&#39;</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="fu">GET</span>(<span class="fu">paste0</span>(baseurl, query)) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  <span class="fu">http_type</span>()</span></code></pre></div>
<pre><code>## [1] &quot;application/json&quot;</code></pre>
<div id="api-keys-and-authentication" class="section level2">
<h2>API keys and authentication üîí`</h2>
<p>For many APIs, you will need to obtain an api key to retrieve data.
Once you received your api key (or token), you will also need to adapt
your GET query. How you need to do this depends a lot on the API. Let‚Äôs
take a look at how to do this with the API for the <a
href="https://api.congress.gov/">US congress</a>. The API is actually
valid across a number of <a href="https://api.data.gov/">US government
institutions</a>. We can sign up for an API key <a
href="https://api.data.gov/signup/">here</a>. The API website, gives us
detailed information on how to build our queries. But how do we actually
authenticate ourselves with the API key? The <a
href="https://api.data.gov/docs/api-key/">documentation</a> tells us
that there are multiple ways to go about this. We can either do adapt
the use HTTP basic authentication, the GET query parameter, or the HTTP
header.</p>
<p>Here‚Äôs a quick overview of how to implement these with
<code>httr</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># sign up for API key: https://api.data.gov/signup/</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="co">#Sys.setenv(MY_API_KEY = &quot;[YOUR API KEY GOES HERE]&quot;) # store your personal API key in R environment</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co"># US Congress: Bills</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>baseurl <span class="ot">&lt;-</span> <span class="st">&quot;https://api.congress.gov/v3/&quot;</span> <span class="co"># base url (remains consistent across queries)</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>api_key <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">&quot;api_key={Sys.getenv(&#39;MY_API_KEY&#39;)}&quot;</span>) <span class="co"># your personal API key</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&quot;bill&quot;</span> <span class="co"># query</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="fu">GET</span>(glue<span class="sc">::</span><span class="fu">glue</span>(baseurl, query, <span class="st">&quot;?&quot;</span>, api_key)) <span class="sc">|&gt;</span> </span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&quot;text&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  <span class="fu">fromJSON</span>() <span class="sc">|&gt;</span> </span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># US Congress: Actions on a specific nomination</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&quot;nomination/115/2259/actions&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="fu">GET</span>(glue<span class="sc">::</span><span class="fu">glue</span>(baseurl, query, <span class="st">&quot;?&quot;</span>, api_key)) <span class="sc">|&gt;</span> </span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&quot;text&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="fu">fromJSON</span>() <span class="sc">|&gt;</span> </span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># US Congress: Summaries filtered by congress and bill type</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&quot;summaries/117/hr?fromDateTime=2022-04-01T00:00:00Z&amp;toDateTime=2022-04-03T00:00:00Z&amp;sort=updateDate+desc&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="fu">GET</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">&quot;{baseurl}{query}&amp;{api_key}&quot;</span>)) <span class="sc">|&gt;</span> <span class="co"># another way of using glue()</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&#39;text&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="fu">fromJSON</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># US Congress: Legislation sponsored by a specific congress member</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>query <span class="ot">&lt;-</span> <span class="st">&quot;member/L000174/sponsored-legislation.xml&quot;</span> <span class="co"># data can be formatted as xml too</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="fu">GET</span>(glue<span class="sc">::</span><span class="fu">glue</span>(baseurl, query, <span class="st">&quot;?&quot;</span>, api_key),</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    <span class="fu">add_headers</span>(<span class="st">&quot;X-Api-Key&quot;</span> <span class="ot">=</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;MY_API_KEY&quot;</span>))) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>  <span class="fu">content</span>(<span class="at">as =</span> <span class="st">&quot;text&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>  <span class="fu">read_xml</span>() <span class="sc">|&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>  <span class="fu">xml_find_all</span>(<span class="st">&quot;//sponsoredLegislation//title&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>  <span class="fu">xml_text</span>()</span></code></pre></div>
<p>Retrieving data from API‚Äôs using <code>httr</code> can at times be
quite tiresome. Luckily, there are many R libraries that make it much
easier to retrieve data from APIs. Here is a <a
href="https://ropensci.org/packages/data-access/">list of ready-made R
bindings to web-APIs</a>. Actually, even the starwars API we queried
earlier has its own R package, <code>rwars</code>!</p>
</div>
</div>
<div id="sources" class="section level1">
<h1>Sources</h1>
<p>This tutorial drew heavily on Simon Munzert‚Äôs book <a
href="http://r-datacollection.com/">Automated Data Collection with R</a>
and related <a
href="https://github.com/simonmunzert/web-scraping-with-r-extended-edition">course
materials</a>. We also used an <a
href="https://keith-mcnulty.medium.com/how-to-scrape-the-web-in-r-d77b11fca40d">example</a>
from Keith McNulty‚Äôs blog post on tidy web scraping in R. For the regex
part, we used examples from the string manipulation section in Hadley
Wickham‚Äôs <a href="https://r4ds.hadley.nz/strings">R for Data
Science</a> book.</p>
</div>

&nbsp;
<hr />
<p style="text-align: center;">A work by Lisa Oswald & Tom Arend</a></p>
<p style="text-align: center;"><span style="color: #808080;"><em>Prepared for Intro to Data Science, taught by Simon Munzert</em></span></p>
<p style="text-align: center;"><span style="color: #808080;"><em><a href="https://www.hertie-school.org/en/">Hertie School, Berlin</em></span></p>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" >

<!-- Add font awesome icons -->
<p style="text-align: center;">
    <a href="https://github.com/intro-to-data-science-23"  <i class="fab fa-github"></i><a>
</p>

&nbsp;


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
